<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <style>
      body {
        font-family: Arial, sans-serif;
        background-image: url('003.png');
        background-size: cover;
        background-position: top center;
        background-attachment: fixed;
        background-repeat: no-repeat;
        text-align: center;
        padding: 50px;
      }
      #spinSound, #finishSound {
        display: none;
      }

      h1, h4 {
        color: rgba(0, 0, 0, 0);
      }

      .slot-machine-wrapper {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 40px;
      }

      .reel-box {
        width: 450px;
        height: 80px;
        border-radius: 10px;
        font-size: 40px;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #333;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        padding: 0 20px;
        box-sizing: border-box;
        text-align: center;
      }
      
      button {
        margin: 10px;
        padding: 15px 30px;
        font-size: 16px;
        font-weight: bold;
        background-color: #ff9900;
        color: white;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }

      button:hover {
        background-color: #e68a00;
      }

      button:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
      }

      #resetHistoryButton {
        background-color: #666;
      }
      #resetHistoryButton:hover {
        background-color: #555;
      }

      #restartButton {
        background-color: #0066cc;
      }
      #restartButton:hover {
        background-color: #005bb5;
      }

      #result {
        margin-top: 30px;
        font-size: 18px;
        color: #333;
        font-weight: bold;
      }

      #result b {
        color: #003366;
      }

      #history {
        margin-top: 40px;
        text-align: left;
        max-width: 400px;
        margin-left: auto;
        margin-right: auto;
        background: rgba(255, 255, 255, 0.9);
        padding: 15px;
        border-radius: 10px;
        border: 1px solid #ccc;
        min-height: 100px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        overflow-y: auto;
        max-height: 250px;
      }

      #history div {
        margin-bottom: 5px;
      }
    </style>
  </head>
<body>
    <!-- 彈出視窗區塊 -->
    <div id="modalContainer" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold">請選擇要使用的名單：</h2>
            <div class="modal-button-group">
                <button id="selectList1Btn" class="modal-button">組別</button>
                <button id="selectList2Btn" class="modal-button">個人</button>
            </div>
        </div>
    </div>

    <!-- 主容器 -->
    <div id="pickerContainer" class="container">
        <!-- 廟宇框架 -->
        <div class="temple-frame">
            <div class="logo-circle">
                <h1 class="title">抽獎</h1>
            </div>
            
            <div class="side-banner left">
                <p>加入團隊以求兼善</p>
            </div>
            <div class="side-banner right">
                <p>邊學邊做不唯自尊</p>
            </div>

            <!-- 核心功能區塊 -->
            <div class="main-content">
                <div id="resultBox" class="result-box">--</div>
                <div class="button-group">
                    <button id="pickBtn" class="button" disabled>開始抽獎</button>
                    <button id="clearHistoryBtn" class="button">清除紀錄</button>
                </div>
                
                <div id="message" class="message"></div>

                <div class="history-container">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="history-title">抽獎紀錄</h2>
                        <span id="historyCount" class="text-sm text-gray-500">已抽出：0人</span>
                    </div>
                    <ul id="historyList" class="history-list">
                        <!-- 記錄將在這裡顯示 -->
                    </ul>
                </div>
            </div>
            
        </div>
        
        <!-- 模擬拉桿 -->
        <div class="lever-container">
            <div class="lever-handle"></div>
            <div class="lever-ball"></div>
        </div>

    </div>

    <script>
        // 拖曳功能
        const pickerContainer = document.getElementById('pickerContainer');
        let isDragging = false;
        let offset = { x: 0, y: 0 };

        pickerContainer.addEventListener('mousedown', (e) => {
            isDragging = true;
            offset.x = e.clientX - pickerContainer.getBoundingClientRect().left;
            offset.y = e.clientY - pickerContainer.getBoundingClientRect().top;
            pickerContainer.style.cursor = 'grabbing';
        });
        
        pickerContainer.addEventListener('touchstart', (e) => {
            isDragging = true;
            const touch = e.touches[0];
            offset.x = touch.clientX - pickerContainer.getBoundingClientRect().left;
            offset.y = touch.clientY - pickerContainer.getBoundingClientRect().top;
            pickerContainer.style.cursor = 'grabbing';
            e.preventDefault();
        });

        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            const newX = e.clientX - offset.x;
            const newY = e.clientY - offset.y;
            pickerContainer.style.left = `${newX}px`;
            pickerContainer.style.top = `${newY}px`;
        });
        
        document.addEventListener('touchmove', (e) => {
            if (!isDragging) return;
            const touch = e.touches[0];
            const newX = touch.clientX - offset.x;
            const newY = touch.clientY - offset.y;
            pickerContainer.style.left = `${newX}px`;
            pickerContainer.style.top = `${newY}px`;
            e.preventDefault();
        });

        document.addEventListener('mouseup', () => {
            isDragging = false;
            pickerContainer.style.cursor = 'grab';
        });
        
        document.addEventListener('touchend', () => {
            isDragging = false;
            pickerContainer.style.cursor = 'grab';
        });

        // 隨機選取器邏輯
        const SPREADSHEET_ID = '1BgOdR7cQzFpKYPim5sxIo3eC2JN5CWOtfg-oYdd_3EQ';
        const GIDS = {
            '名單一': '921041441',
            '名單二': '824754110'
        };
        
        const modalContainer = document.getElementById('modalContainer');
        const selectList1Btn = document.getElementById('selectList1Btn');
        const selectList2Btn = document.getElementById('selectList2Btn');
        
        const resultBox = document.getElementById('resultBox');
        const pickBtn = document.getElementById('pickBtn');
        const messageDiv = document.getElementById('message');
        const historyList = document.getElementById('historyList');
        const historyCountSpan = document.getElementById('historyCount');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');
        
        let currentGid = '';
        let teamsData = [];
        let allData = {};
        let isPicking = false;
        let drawHistory = [];

        async function fetchTeamsData(gid) {
            try {
                if (allData[gid]) {
                    return allData[gid];
                }

                const TEAMS_SHEET_URL = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json&gid=${gid}`;
                
                const response = await fetch(TEAMS_SHEET_URL);
                const text = await response.text();
                const jsonText = text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1);
                const data = JSON.parse(jsonText);

                const parsedData = data.table.rows.map(row => {
                    if (row.c.length > 1 && row.c[1] && row.c[1].v) {
                        return `${row.c[0].v}: ${row.c[1].v}`;
                    } else if (row.c[0] && row.c[0].v) {
                        return row.c[0].v;
                    }
                    return null;
                }).filter(item => item !== null);

                allData[gid] = parsedData;
                return parsedData;

            } catch (error) {
                console.error('載入姓名資料失敗:', error);
                messageDiv.textContent = '載入資料失敗。請檢查您的試算表網址和權限設定。';
                return [];
            }
        }

        async function updateList() {
            const fetchedData = await fetchTeamsData(currentGid);
            teamsData = [...fetchedData];
            
            if (teamsData.length > 0) {
                resultBox.textContent = '準備好了！';
                pickBtn.disabled = false;
                if (messageDiv) {
                    messageDiv.textContent = '';
                }
            } else {
                resultBox.textContent = '載入失敗';
                pickBtn.disabled = true;
                if (messageDiv) {
                    messageDiv.textContent = '試算表中沒有找到可用的姓名資料。';
                }
            }
            drawHistory = [];
            renderHistory();
        }

        function renderHistory() {
            historyList.innerHTML = '';
            drawHistory.forEach((item, index) => {
                const li = document.createElement('li');
                li.className = 'history-item';
                li.textContent = `${index + 1}. ${item}`;
                historyList.prepend(li);
            });
            historyCountSpan.textContent = `已抽出：${drawHistory.length}人`;
        }

        function startPicking() {
            if (isPicking || teamsData.length === 0) {
                if (teamsData.length === 0 && messageDiv) {
                    messageDiv.textContent = '名單已抽完，請點擊「清除紀錄」重新開始。';
                }
                return;
            }

            isPicking = true;
            pickBtn.disabled = true;
            if (messageDiv) {
                messageDiv.textContent = '';
            }
            
            let count = 0;
            const originalData = allData[currentGid];
            const pickingInterval = setInterval(() => {
                const randomIndex = Math.floor(Math.random() * originalData.length);
                const item = originalData[randomIndex];
                
                resultBox.textContent = item;
                
                count++;

                if (count > 30) {
                    clearInterval(pickingInterval);
                    isPicking = false;
                    const finalIndex = Math.floor(Math.random() * teamsData.length);
                    const finalItem = teamsData[finalIndex];
                    
                    resultBox.textContent = finalItem;
                    
                    if (messageDiv) {
                        messageDiv.textContent = '選取完成！';
                    }
                    drawHistory.push(finalItem);
                    teamsData.splice(finalIndex, 1);
                    renderHistory();
                    
                    if (teamsData.length > 0) {
                        pickBtn.disabled = false;
                    } else {
                        pickBtn.disabled = true;
                        if (messageDiv) {
                            messageDiv.textContent = '名單已抽完！請點擊「清除紀錄」重新開始。';
                        }
                    }
                }
            }, 50);
        }

        function clearHistory() {
            drawHistory = [];
            renderHistory();
            updateList();
            if (messageDiv) {
                messageDiv.textContent = '紀錄已清除，名單已重置。';
            }
        }

        pickBtn.addEventListener('click', startPicking);
        clearHistoryBtn.addEventListener('click', clearHistory);

        // 初始化彈出視窗和名單載入
        selectList1Btn.addEventListener('click', () => {
            currentGid = GIDS['名單一'];
            modalContainer.style.display = 'none';
            updateList();
        });

        selectList2Btn.addEventListener('click', () => {
            currentGid = GIDS['名單二'];
            modalContainer.style.display = 'none';
            updateList();
        });
    </script>
</body>
</html>


